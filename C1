import cv2
import numpy as np
import smtplib
import time
from gpiozero import LED
import tflite_runtime.interpreter as tflite

MONITORED_FOODS = ["apple", "banana", "orange"]
YOUR_EMAIL = "YOUR_EMAIL@gmail.com"
YOUR_APP_PASSWORD = "YOUR_APP_PASSWORD"
SEND_TO_EMAIL = "RECIPIENT_EMAIL@gmail.com"


# LED on GPIO pin 18
led = LED(18)

labels = {}
labels = {}
with open("coco_labels.txt", "r") as f:
    for i, line in enumerate(f):
        labels[i] = line.strip()

interpreter = tflite.Interpreter("coco_ssd_mobilenet_v1_1.0.tflite")
interpreter.allocate_tensors()

input_details = interpreter.get_input_details()
output_details = interpreter.get_output_details()

def send_email (missing_items):
    message = f"Subject: Community Fridge Alert\n\nMissing items: {missing_items}"
    server = smtplib.SMTP_SSL("smtp.gmail.com", 465)
    server.login(YOUR_EMAIL, YOUR_APP_PASSWORD)
    server.sendmail(YOUR_EMAIL, SEND_TO_EMAIL, message)
    server.quit()
    Print ("Email Sent!")

cap = cv2.VideoCapture(0)
print("Smart fridge monitor running...")
last_email_time = 0

while True:
    ret, frame = cap.read()
    if not ret:
        continue

img = cv2.resize(frame, (300, 300))
img = np.expand_dims(img, axis=0)

interpreter.set_tensor(input_details[0]['index'], img)
interpreter.invoke()

scores = interpreter.get_tensor(output_details[2]['index'])[0]
classes = interpreter.get_tensor (output_details [1]['index'])[0]

detected_foods = set()

#Look for food items
for i in range(len(scores)):
    if scores[i] > 0.5:
        item = labels [int(classes[i])]
        if item in MONITORED_FOODS:
            detected_foods.add(item)

missing = [item for item in MONITORED_FOODS if item not in detected_foods]

if missing:
    print("Missing:", missing)
    # Blink LED once
    led.on()
    time.sleep(0.3)
    led.off()
    # Send email max once every 60 sec
    if time.time() - last_email_time > 60:
        send_email(missing)
        last_email_time = time.time()
else:
    print("All items present")
    led.off()

# Blink LED once
led.on()
time.sleep(0.3)
led.off()

# Send email max once every 60 sec
if time.time() - last_email_time > 60:
    send_email(missing)
    last_email_time = time.time()
else:
    print("All items present")
    led.off()
    time.sleep(1)

# Cleanup (won't run unless loop is broken)
cap.release()


